<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cifrar/Descifrar Texto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.24.4/docxtemplater.min.js"></script>
</head>
<body>
    <h1>Cifrado de Archivos de Texto</h1>

    <label for="action">Elige una opción:</label>
    <select id="action">
        <option value="1">Cifrar</option>
        <option value="2">Descifrar</option>
    </select>
    <br><br>

    <label for="fileInput">Selecciona el archivo (TXT, DOCX):</label>
    <input type="file" id="fileInput" accept=".txt, .docx">
    <br><br>

    <button onclick="procesarArchivo()">Procesar</button>

    <script>
        function desplazarCaracteres(texto, x, cifrar = true) {
            let textoProcesado = '';
            for (let i = 0; i < texto.length; i++) {
                let caracter = texto[i];
                let desplazamiento;

                // Cifrar todos los caracteres incluyendo espacios, números y letras
                desplazamiento = (caracter.charCodeAt(0) + (cifrar ? x : -x)) % 256; // 256 para cubrir todos los caracteres ASCII
                if (desplazamiento < 0) desplazamiento += 256; // Asegurarse de que no sea negativo
                textoProcesado += String.fromCharCode(desplazamiento);
            }
            return textoProcesado;
        }

        function generarNombreAleatorio(extension) {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let nombre = '';
            for (let i = 0; i < 10; i++) {
                nombre += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return nombre + extension;
        }

        function procesarArchivo() {
            const fileInput = document.getElementById('fileInput');
            const action = document.getElementById('action').value;

            if (!fileInput.files.length) {
                alert('Por favor, selecciona un archivo de texto.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            // Manejo de archivos DOCX
            if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                reader.onload = function(event) {
                    const arrayBuffer = event.target.result;
                    mammoth.extractRawText({arrayBuffer: arrayBuffer})
                        .then(function(result) {
                            const contenido = result.value; // Texto extraído
                            procesarContenido(contenido, action, '.docx'); // Generar archivo DOCX
                        })
                        .catch(function(err) {
                            console.error(err);
                            alert('Error al leer el archivo DOCX.');
                        });
                };
                reader.readAsArrayBuffer(file);
            } 
            // Manejo de archivos TXT
            else if (file.type === 'text/plain') {
                reader.onload = function(event) {
                    const contenido = event.target.result;
                    procesarContenido(contenido, action, '.txt'); // Generar archivo TXT
                };
                reader.readAsText(file);
            } else {
                alert('Tipo de archivo no soportado. Usa TXT o DOCX.');
                return;
            }
        }

        function procesarContenido(contenido, action, extension) {
            if (action === '1') {  // Cifrar
                const desplazamiento = Math.floor(Math.random() * 200) - 100; // Genera un número aleatorio entre -100 y 100
                const resultadoTexto = desplazarCaracteres(contenido, desplazamiento, true) + String.fromCharCode(desplazamiento);

                crearArchivo(resultadoTexto, extension); // Generar archivo de salida
            } else if (action === '2') {  // Descifrar
                if (contenido.length === 0) {
                    alert('El archivo está vacío.');
                    return;
                }

                // Extraer el último carácter para obtener el desplazamiento
                const desplazamiento = contenido.charCodeAt(contenido.length - 1);
                const textoSinDesplazamiento = contenido.slice(0, -1);
                const resultadoTexto = desplazarCaracteres(textoSinDesplazamiento, desplazamiento, false);

                crearArchivo(resultadoTexto, extension); // Generar archivo de salida
            }
        }

        function crearArchivo(contenido, extension) {
            let blob;
            if (extension === '.docx') {
                const zip = new JSZip();
                zip.file("document.txt", contenido); // Agregar contenido al archivo zip
                const doc = new window.Docxtemplater();
                doc.loadZip(zip);
                try {
                    doc.render();
                } catch (error) {
                    console.error(JSON.stringify({ error: error }, null, 2));
                    alert('Error al generar el archivo DOCX.');
                    return;
                }
                blob = new Blob([doc.getZip().generate({ type: 'blob' })], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            } else if (extension === '.txt') {
                blob = new Blob([contenido], { type: 'text/plain' });
            }

            const nombreArchivoSalida = generarNombreAleatorio(extension);
            const enlaceDescarga = document.createElement('a');
            enlaceDescarga.href = URL.createObjectURL(blob);
            enlaceDescarga.download = nombreArchivoSalida;
            document.body.appendChild(enlaceDescarga);
            enlaceDescarga.click();
            document.body.removeChild(enlaceDescarga);
        }
    </script>
</body>
</html>
