<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cifrar/Descifrar Texto</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
</head>
<body>
    <h1>Cifrado de Archivos de Texto</h1>

    <label for="action">Elige una opción:</label>
    <select id="action">
        <option value="1">Cifrar</option>
        <option value="2">Descifrar</option>
    </select>
    <br><br>

    <label for="fileInput">Selecciona el archivo (TXT, DOC, DOCX):</label>
    <input type="file" id="fileInput" accept=".txt, .doc, .docx">
    <br><br>

    <button onclick="procesarArchivo()">Procesar</button>

    <script>
        function desplazarCaracteres(texto, x, cifrar = true) {
            let textoProcesado = '';
            for (let i = 0; i < texto.length; i++) {
                let caracter = texto[i];
                let desplazamiento = (caracter.charCodeAt(0) + (cifrar ? x : -x)) % 256; // 256 para cubrir todos los caracteres ASCII
                if (desplazamiento < 0) desplazamiento += 256; // Asegurarse de que no sea negativo
                textoProcesado += String.fromCharCode(desplazamiento);
            }
            return textoProcesado;
        }

        function generarNombreAleatorio() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let nombre = '';
            for (let i = 0; i < 10; i++) {
                nombre += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return nombre + '.txt';
        }

        function procesarArchivo() {
            const fileInput = document.getElementById('fileInput');
            const action = document.getElementById('action').value;

            if (!fileInput.files.length) {
                alert('Por favor, selecciona un archivo de texto.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            // Manejo de archivos DOCX
            if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                reader.onload = function(event) {
                    const arrayBuffer = event.target.result;
                    mammoth.extractRawText({arrayBuffer: arrayBuffer})
                        .then(function(result) {
                            const contenido = result.value; // Texto extraído
                            procesarContenido(contenido, action);
                        })
                        .catch(function(err) {
                            console.error(err);
                            alert('Error al leer el archivo DOCX.');
                        });
                };
                reader.readAsArrayBuffer(file);
            } 
            // Manejo de archivos DOC (puedes agregar soporte similar aquí)
            else if (file.type === 'application/msword') {
                alert('El soporte para archivos DOC no está implementado. Por favor, usa DOCX o TXT.');
                return;
            }
            // Manejo de archivos TXT
            else {
                reader.onload = function(event) {
                    const contenido = event.target.result;
                    procesarContenido(contenido, action);
                };
                reader.readAsText(file);
            }
        }

        function procesarContenido(contenido, action) {
            if (action === '1') {  // Cifrar
                const desplazamiento = Math.floor(Math.random() * 200) - 100; // Genera un número aleatorio entre -100 y 100
                const resultadoTexto = desplazarCaracteres(contenido, desplazamiento, true) + String.fromCharCode(desplazamiento);
                const nombreArchivoSalida = generarNombreAleatorio();
                descargarArchivo(resultadoTexto, nombreArchivoSalida);
            } else if (action === '2') {  // Descifrar
                if (contenido.length === 0) {
                    alert('El archivo está vacío.');
                    return;
                }

                // Extraer el último carácter para obtener el desplazamiento
                const desplazamiento = contenido.charCodeAt(contenido.length - 1);
                const textoSinDesplazamiento = contenido.slice(0, -1);
                const resultadoTexto = desplazarCaracteres(textoSinDesplazamiento, desplazamiento, false);
                const nombreArchivoSalida = generarNombreAleatorio();
                descargarArchivo(resultadoTexto, nombreArchivoSalida);
            }
        }

        function descargarArchivo(contenido, nombreArchivo) {
            const blob = new Blob([contenido], { type: 'text/plain' });
            const enlaceDescarga = document.createElement('a');
            enlaceDescarga.href = URL.createObjectURL(blob);
            enlaceDescarga.download = nombreArchivo;
            document.body.appendChild(enlaceDescarga);
            enlaceDescarga.click();
            document.body.removeChild(enlaceDescarga);
        }
    </script>
</body>
</html>
